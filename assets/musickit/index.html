<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ Apple Music - MusicKit JS</title>
    <script src="https://js-cdn.music.apple.com/musickit/v1/musickit.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
            text-align: center;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(45deg, #007AFF, #5856D6);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            transform: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }
        .hidden {
            display: none;
        }
        .player-controls {
            margin-top: 30px;
        }
        .player-controls .btn {
            width: calc(50% - 10px);
            display: inline-block;
        }
        .track-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #007AFF;
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸµ</div>
        <h1>Apple Music</h1>
        <p>çœŸæ­£çš„åœ¨çº¿éŸ³ä¹æ’­æ”¾ä½“éªŒ</p>
        
        <div id="loginSection">
            <button id="authorizeBtn" class="btn">ğŸ ç™»å½• Apple Music</button>
            <div class="status" id="status">ç­‰å¾…ç™»å½•...</div>
        </div>
        
        <div id="playerSection" class="hidden">
            <div class="track-info">
                <h3 id="trackTitle">æœªé€‰æ‹©æ­Œæ›²</h3>
                <p id="trackArtist">-</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
            </div>
            
            <div class="player-controls">
                <button id="playBtn" class="btn">â–¶ï¸ æ’­æ”¾</button>
                <button id="pauseBtn" class="btn">â¸ï¸ æš‚åœ</button>
            </div>
            
            <div class="player-controls">
                <button id="demoSong1" class="btn">ğŸµ æ’­æ”¾çƒ­é—¨æ­Œæ›²</button>
                <button id="demoSong2" class="btn">ğŸ¶ æ’­æ”¾æ¨èæ­Œæ›²</button>
            </div>
            
            <button id="logoutBtn" class="btn" style="background: linear-gradient(45deg, #FF3B30, #FF9500); margin-top: 20px;">ğŸšª é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <script>
        let musicKit;
        let isInitialized = false;
        let currentTrack = null;
        
        // MusicKit JS é…ç½®
        const DEVELOPER_TOKEN = 'YOUR_DEVELOPER_TOKEN_HERE'; // éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„å¼€å‘è€…ä»¤ç‰Œ
        
        // çŠ¶æ€å…ƒç´ 
        const statusEl = document.getElementById('status');
        const loginSection = document.getElementById('loginSection');
        const playerSection = document.getElementById('playerSection');
        const authorizeBtn = document.getElementById('authorizeBtn');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const demoSong1 = document.getElementById('demoSong1');
        const demoSong2 = document.getElementById('demoSong2');
        
        // æ’­æ”¾ä¿¡æ¯å…ƒç´ 
        const trackTitle = document.getElementById('trackTitle');
        const trackArtist = document.getElementById('trackArtist');
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.style.background = isError ? 'rgba(255, 59, 48, 0.3)' : 'rgba(52, 199, 89, 0.3)';
            console.log('çŠ¶æ€æ›´æ–°:', message);
            
            // é€šçŸ¥Flutter
            if (window.flutter_inappwebview) {
                window.flutter_inappwebview.callHandler('onStatusUpdate', {
                    message: message,
                    isError: isError
                });
            }
        }
        
        // MusicKit åˆå§‹åŒ–
        document.addEventListener('musickitloaded', function() {
            console.log('MusicKit JS å·²åŠ è½½');
            
            try {
                musicKit = MusicKit.configure({
                    developerToken: DEVELOPER_TOKEN,
                    app: {
                        name: 'Apple Music é¸¿è’™ç‰ˆ',
                        build: '1.0.0'
                    }
                });
                
                isInitialized = true;
                updateStatus('ğŸµ MusicKit åˆå§‹åŒ–æˆåŠŸ');
                authorizeBtn.disabled = false;
                
                // ç›‘å¬æ’­æ”¾äº‹ä»¶
                musicKit.addEventListener('playbackStateDidChange', handlePlaybackStateChange);
                musicKit.addEventListener('nowPlayingItemDidChange', handleNowPlayingItemChange);
                musicKit.addEventListener('playbackTimeDidChange', handlePlaybackTimeChange);
                
            } catch (error) {
                console.error('MusicKit åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('âŒ MusicKit åˆå§‹åŒ–å¤±è´¥: ' + error.message, true);
            }
        });
        
        // Apple Music æˆæƒç™»å½•
        async function authorize() {
            if (!isInitialized) {
                updateStatus('âŒ MusicKit æœªåˆå§‹åŒ–', true);
                return;
            }
            
            try {
                updateStatus('ğŸ” æ­£åœ¨æˆæƒ...');
                authorizeBtn.disabled = true;
                
                const userToken = await musicKit.authorize();
                console.log('æˆæƒæˆåŠŸï¼ŒUser Token:', userToken);
                
                updateStatus('âœ… ç™»å½•æˆåŠŸï¼');
                
                // æ˜¾ç¤ºæ’­æ”¾å™¨ç•Œé¢
                loginSection.classList.add('hidden');
                playerSection.classList.remove('hidden');
                
                // é€šçŸ¥Flutterç™»å½•æˆåŠŸ
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('onAuth', {
                        userToken: userToken,
                        isAuthorized: true
                    });
                }
                
            } catch (error) {
                console.error('æˆæƒå¤±è´¥:', error);
                updateStatus('âŒ ç™»å½•å¤±è´¥: ' + error.message, true);
                authorizeBtn.disabled = false;
                
                // é€šçŸ¥Flutterç™»å½•å¤±è´¥
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('onAuth', {
                        error: error.message,
                        isAuthorized: false
                    });
                }
            }
        }
        
        // æ’­æ”¾æ­Œæ›²
        async function playSong(songId, songTitle = '') {
            if (!musicKit || !musicKit.isAuthorized) {
                updateStatus('âŒ è¯·å…ˆç™»å½• Apple Music', true);
                return;
            }
            
            try {
                updateStatus('ğŸµ æ­£åœ¨åŠ è½½æ­Œæ›²...');
                
                await musicKit.setQueue({
                    song: songId
                });
                
                await musicKit.play();
                updateStatus(`â–¶ï¸ æ­£åœ¨æ’­æ”¾: ${songTitle || songId}`);
                
                // é€šçŸ¥Flutteræ’­æ”¾çŠ¶æ€
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('onPlaybackStart', {
                        songId: songId,
                        songTitle: songTitle
                    });
                }
                
            } catch (error) {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                updateStatus('âŒ æ’­æ”¾å¤±è´¥: ' + error.message, true);
            }
        }
        
        // å¤„ç†æ’­æ”¾çŠ¶æ€å˜åŒ–
        function handlePlaybackStateChange() {
            const state = musicKit.playbackState;
            console.log('æ’­æ”¾çŠ¶æ€å˜åŒ–:', state);
            
            if (window.flutter_inappwebview) {
                window.flutter_inappwebview.callHandler('onPlaybackStateChange', {
                    state: state
                });
            }
        }
        
        // å¤„ç†å½“å‰æ’­æ”¾é¡¹å˜åŒ–
        function handleNowPlayingItemChange() {
            const nowPlayingItem = musicKit.nowPlayingItem;
            if (nowPlayingItem) {
                trackTitle.textContent = nowPlayingItem.title || 'æœªçŸ¥æ­Œæ›²';
                trackArtist.textContent = nowPlayingItem.artistName || 'æœªçŸ¥è‰ºæœ¯å®¶';
                
                console.log('å½“å‰æ’­æ”¾:', nowPlayingItem.title, '-', nowPlayingItem.artistName);
                
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('onTrackChange', {
                        title: nowPlayingItem.title,
                        artist: nowPlayingItem.artistName,
                        artwork: nowPlayingItem.artwork
                    });
                }
            }
        }
        
        // å¤„ç†æ’­æ”¾æ—¶é—´å˜åŒ–
        function handlePlaybackTimeChange() {
            const currentTime = musicKit.currentPlaybackTime;
            const duration = musicKit.currentPlaybackDuration;
            
            if (duration > 0) {
                const progress = (currentTime / duration) * 100;
                progressFill.style.width = progress + '%';
                
                currentTimeEl.textContent = formatTime(currentTime);
                durationEl.textContent = formatTime(duration);
            }
        }
        
        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            if (musicKit) {
                musicKit.unauthorize();
            }
            
            loginSection.classList.remove('hidden');
            playerSection.classList.add('hidden');
            authorizeBtn.disabled = false;
            
            updateStatus('ğŸ‘‹ å·²é€€å‡ºç™»å½•');
            
            if (window.flutter_inappwebview) {
                window.flutter_inappwebview.callHandler('onLogout', {});
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        authorizeBtn.addEventListener('click', authorize);
        playBtn.addEventListener('click', () => musicKit && musicKit.play());
        pauseBtn.addEventListener('click', () => musicKit && musicKit.pause());
        logoutBtn.addEventListener('click', logout);
        
        // æ¼”ç¤ºæ­Œæ›²ï¼ˆéœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„Apple Musicæ›²ç›®IDï¼‰
        demoSong1.addEventListener('click', () => playSong('1490910932', 'Blinding Lights - The Weeknd'));
        demoSong2.addEventListener('click', () => playSong('1463965103', 'Watermelon Sugar - Harry Styles'));
        
        // æä¾›ç»™Flutterè°ƒç”¨çš„å‡½æ•°
        window.playAppleMusicSong = playSong;
        window.pauseAppleMusic = () => musicKit && musicKit.pause();
        window.resumeAppleMusic = () => musicKit && musicKit.play();
        window.getPlaybackState = () => musicKit ? musicKit.playbackState : null;
        
        console.log('ğŸµ Apple Music MusicKit JS ç•Œé¢åŠ è½½å®Œæˆ');
        updateStatus('ğŸ ç‚¹å‡»æŒ‰é’®ç™»å½• Apple Music');
    </script>
</body>
</html> 